<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disease & Weather Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {background: #f5f7fa; font-family: 'Segoe UI', sans-serif;}
    #map {height: 400px; border-radius: 10px; margin-bottom: 20px;}
    .card {border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
    .risk-red {background:#ffe5e5;}
    .risk-yellow {background:#fff9e5;}
    .risk-green {background:#e5ffe5;}
    .advice-card {margin-bottom: 10px;}
    .chat-box {border:1px solid #ccc;padding:10px;border-radius:10px;background:#fff;}
  </style>
</head>
<body class="container py-3">
  <h1 class="text-center mb-3">üåç Disease & Weather Dashboard</h1>

  <div id="map"></div>

  <div class="row" id="info-row">
    <div class="col-md-6">
      <div class="card p-3" id="weatherCard">
        <h4>üå§Ô∏è Weather</h4>
        <p>Max Temp: <span id="maxTemp"></span>¬∞C</p>
        <p>Min Temp: <span id="minTemp"></span>¬∞C</p>
        <p>Precipitation: <span id="precip"></span> mm</p>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3" id="healthCard">
        <h4>ü¶ü Health Data</h4>
        <p>State: <span id="stateName"></span></p>
        <p>Dengue: <span id="dengue"></span></p>
        <p>Malaria: <span id="malaria"></span></p>
        <p>Chikungunya: <span id="chikungunya"></span></p>
        <p>Risk: <span id="risk"></span></p>
      </div>
    </div>
  </div>

  <h4 class="mt-4">üìù Precautions</h4>
  <div class="row" id="adviceRow"></div>

  <h4 class="mt-4">üí¨ Ask the AI Bot</h4>
  <div class="chat-box">
    <textarea id="botInput" rows="3" class="form-control" placeholder="Ask about weather, diseases, precautions..."></textarea>
    <button class="btn btn-primary mt-2" onclick="sendToBot()">Ask</button>
    <p><strong>Bot says:</strong></p>
    <div id="botReply" style="white-space: pre-wrap;"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([20.5937,78.9629],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    // Ask browser for location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(successLoc, manualFallback);
    } else {
      manualFallback();
    }

    function manualFallback() {
      // fallback center India
      fetchData(20.5937,78.9629);
    }

    function successLoc(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      map.setView([lat,lon],7);
      fetchData(lat,lon);
    }

    function fetchData(lat,lon) {
      fetch('/data',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({lat:lat,lon:lon})
      })
      .then(res=>res.json())
      .then(data=>{
        displayData(lat,lon,data);
      });
    }

    function displayData(lat,lon,data){
      // Weather
      document.getElementById('maxTemp').innerText=data.weather.max_temp;
      document.getElementById('minTemp').innerText=data.weather.min_temp;
      document.getElementById('precip').innerText=data.weather.precipitation;

      // Health
      document.getElementById('stateName').innerText=data.health.state;
      document.getElementById('dengue').innerText=data.health.dengue;
      document.getElementById('malaria').innerText=data.health.malaria;
      document.getElementById('chikungunya').innerText=data.health.chikungunya;
      document.getElementById('risk').innerText=data.health.risk;

      // risk color
      let riskClass = 'risk-green';
      if(data.health.risk==='red') riskClass='risk-red';
      if(data.health.risk==='yellow') riskClass='risk-yellow';
      document.getElementById('healthCard').className='card p-3 '+riskClass;

      // Marker with color
      let color = data.health.risk==='red'?'red':(data.health.risk==='yellow'?'orange':'green');
      L.circleMarker([lat,lon],{radius:12,color:color,fillColor:color,fillOpacity:0.5}).addTo(map)
        .bindPopup(`<b>${data.health.state}</b><br>Dengue:${data.health.dengue}<br>Malaria:${data.health.malaria}`);

      // Precaution cards
      const advRow=document.getElementById('adviceRow');
      advRow.innerHTML='';
      let advList=data.health.risk==='red'
        ?['Eliminate stagnant water ü¶ü','Wear full-sleeves üëï','Use repellents üß¥','Stay indoors in heat ‚òÄÔ∏è']
        :data.health.risk==='yellow'
        ?['Clean water storage üíß','Use nets at night üõèÔ∏è','Stay hydrated üö∞']
        :['Conditions safe üòé','Maintain hygiene üßº','Regular health checkups üè•'];
      advList.forEach(txt=>{
        advRow.innerHTML+=`<div class="col-md-4"><div class="card advice-card p-3">${txt}</div></div>`;
      });
    }

    function sendToBot(){
      const msg=document.getElementById('botInput').value;
      document.getElementById('botReply').innerText='Thinking...';
      fetch('/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message:msg})
      })
      .then(res=>res.json())
      .then(data=>{
        document.getElementById('botReply').innerText=data.reply;
      });
    }
  </script>
</body>
</html>

