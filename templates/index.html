<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Disease & Weather Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body {
  background: linear-gradient(135deg,#e8f0f9,#ffffff);
  font-family: 'Segoe UI', sans-serif;
}
.hero {
  background: #007BFF;
  color: white;
  padding: 40px 0;
  text-align: center;
  border-radius: 0 0 20px 20px;
  margin-bottom: 20px;
}
.card {
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
#map {
  height: 400px;
  width: 100%;
  border-radius:15px;
  margin-top:20px;
}
.precautions ul {
  list-style-type: square;
  padding-left: 20px;
}
.chat-box {
  background:white;
  padding:20px;
  border-radius:15px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
</style>
</head>
<body>
<div class="hero">
  <h1>Disease & Weather Portal ğŸŒ¦ï¸ğŸ¦Ÿ</h1>
  <p>Get live weather, health risks & AI advice for your location</p>
</div>
<div class="container">
  <!-- Location Selector -->
  <div class="card p-4 mb-4">
    <h3 class="mb-3">ğŸŒ Choose Location</h3>
    <div class="row g-2">
      <div class="col-md-4">
        <button class="btn btn-primary w-100" onclick="getLocation()">ğŸ“ Use My Location</button>
      </div>
      <div class="col-md-5">
        <input type="text" id="manualLocation" class="form-control" placeholder="Enter city or place">
      </div>
      <div class="col-md-3">
        <button class="btn btn-success w-100" onclick="manualLocation()">ğŸ” Search</button>
      </div>
    </div>
  </div>

  <div id="info" class="mb-4 text-center">
    <p>Select a location to see information here.</p>
  </div>
  <div id="map"></div>

  <!-- AI Bot -->
  <div class="chat-box mt-5">
    <h3>ğŸ¤– Ask Our AI Bot</h3>
    <textarea id="botInput" rows="3" class="form-control mb-3" placeholder="Ask anything about health, weather, or safety..."></textarea>
    <button class="btn btn-primary btn-lg" onclick="sendToBot()">Ask</button>
    <div id="botReply" class="mt-3"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([20,80], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
let marker;

function colorByRisk(risk) {
  if (risk==='red') return 'red';
  if (risk==='yellow') return 'orange';
  return 'green';
}

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position){
      sendData(position.coords.latitude, position.coords.longitude);
    });
  } else {
    alert('Geolocation not supported.');
  }
}

async function manualLocation() {
  const place = document.getElementById('manualLocation').value;
  if (!place) return alert('Enter a place');
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`);
  const data = await res.json();
  if (data.length > 0) {
    sendData(data[0].lat, data[0].lon);
  } else {
    alert('Location not found');
  }
}

async function sendData(lat, lon) {
  document.getElementById('info').innerHTML = `<div class="spinner-border" role="status"></div> Loading data...`;
  const response = await fetch('/data', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({lat: lat, lon: lon})
  });
  const result = await response.json();

  const riskColor = colorByRisk(result.health.risk);
  if (marker) {map.removeLayer(marker);}
  marker = L.circle([lat, lon], {
    color: riskColor,
    fillColor: riskColor,
    fillOpacity:0.4,
    radius: 20000
  }).addTo(map);
  map.setView([lat, lon], 8);

  let precautionsList = result.health.precautions.map(p=>`<li>${p}</li>`).join("");

  document.getElementById('info').innerHTML = `
    <div class="card p-4">
      <h4>ğŸŒ¡ï¸ Weather</h4>
      <p><b>Temperature:</b> ${result.weather.temperature}Â°C | <b>Wind:</b> ${result.weather.windspeed} km/h</p>
      <h4>ğŸ¦Ÿ Health Risk</h4>
      <p>Dengue: ${result.health.dengue}, Malaria: ${result.health.malaria}, Chikungunya: ${result.health.chikungunya}</p>
      <h5>Risk Level: <span style="color:${riskColor};font-weight:bold;text-transform:uppercase">${result.health.risk}</span></h5>
      <div class="precautions mt-3">
        <h5>ğŸ›¡ï¸ Precautions</h5>
        <ul>${precautionsList}</ul>
      </div>
    </div>
  `;
}

async function sendToBot() {
  const userMessage = document.getElementById('botInput').value;
  document.getElementById('botReply').innerHTML = `<div class="spinner-border" role="status"></div> Thinking...`;
  const response = await fetch('/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({message: userMessage})
  });
  const data = await response.json();
  document.getElementById('botReply').innerText = data.reply;
}
</script>
</body>
</html>

